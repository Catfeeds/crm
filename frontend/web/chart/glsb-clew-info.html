<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <title>线索客户-信息来源分布</title>
    <link rel="stylesheet" type="text/css" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-default/index.css">
</head>
<body>
<div class="overflow none" id="overflow"></div>
<section class="main">
    <div class="filterbox">
        <div class="storebox w50">
           <div class="input-wrapper">
               <div class="storeinput">
                    <div class="col-md-8"  id="orgSelect">
                         <el-cascader
                           placeholder="区域和门店"
                           :options="options"
                           @change = "handlechange"
                         ></el-cascader>
                         <input id="shopid" name="shop_id" type="hidden" value="">
                     </div>
               </div>
           </div>
           <div class="cascader-list none">
               <ul class="cascader-menu">
               </ul>
           </div>
        </div>
        <div class="timebox">
           <div class="input-wrapper">
               <div class="timeinput">
                   <input class="datetime yearmonth" type="button" value="2017-03" readonly >
                   <span class="chevron-down"></span>
               </div>
           </div>
           <div class="time-yearmonth timelist none">
              <a class="prev" href="javascript:;"><img src="img/ic_arrowleft.png"></a>
              <a class="next" href="javascript:;"><img src="img/ic_arrowright.png"></a>
              <div class="date-list">
                <div class="swiper-container">
                    <div class="swiper-wrapper">
                    </div>
                </div>
              </div>
           </div>
        </div>
    </div>

    <div class="chart_box">
      <div class="chart_title"><p>信息来源分布-线索</p></div>
      <div class="chart">
          <div id="Risk" style="height:250px;width:100%;text-align:center;"></div>
      </div>
    </div>
    <div class="chart_box">
      <div class="chart_title"><p>信息来源分布-意向客户</p></div>
      <div class="chart">
          <div id="Risk1" style="height:250px;width:100%;text-align:center;"></div>
      </div>
    </div>
</section>
<script type="text/javascript" src="js/zepto.min.js"></script>
<script type="text/javascript" src="js/echarts.min.js" ></script>
<script type="text/javascript" src="js/swiper-3.4.2.jquery.min.js" ></script>
<script type="text/javascript" src="js/common.js" ></script>
<!-- 先引入 Vue -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
 <!-- 引入组件库 -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
 
<script type="text/javascript">
$(function () {
    var myChart = echarts.init(document.getElementById("Risk"));
    var myChart1 = echarts.init(document.getElementById("Risk1"));
    var token=null,os_type=null,level=null,p=null,r=null;
    // var r = JSON.stringify({"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjI4MiwiaXNzIjoiaHR0cDpcL1wvdGVzdC5xeC1hcGkuY2hlY2hlbmcubmV0XC9hcGlcL3VzZXJzXC9sb2dpbiIsImlhdCI6MTQ5NjI5NjIxNywiZXhwIjoxNDk3ODA4MjE3LCJuYmYiOjE0OTYyOTYyMTcsImp0aSI6IjI2MjgwZjAwNTUyZmM2MmFhNzY3OWJiMzM5YjRiNzYzIn0.S7JmKUkeNgWxDC3ryhtF1m8D37Ti2DKmUa_VysLKL24","os_type":"android"});
    // var p = JSON.stringify({"info_owner_id":6,"month":"2017-04"});
    
    if(GetQueryString("platfrom") == 'ios'){
        goods.ready(function(bridge) {
            goods.tocken({"text":document.title},function(param){
                token = param["tocken"];
                level = param["level"];
                os_type = GetQueryString("platfrom");
                r = JSON.stringify({"access_token":token,"os_type":os_type});
                tbjson(false);
            });
        });

    }else{
        token = window.JavaJs.token();
        os_type = window.JavaJs.getOsType();
        level = window.JavaJs.getLevelId();
        r = JSON.stringify({"access_token":token,"os_type":os_type});
        tbjson(false);
    }
    // if(level != 3){
    //     $(".storebox").removeClass("none");
    // }
    //     tbjson(false);
  /*
    *调用方法
    *@dataurl 为接口数据地址
  */
  //门店选择
  $.get('/get-json-data-for-select/index?type=getOrgInfo', {r:r,p:p}, function(jsonData){
      console.log(jsonData);
        new Vue({
            el: '#orgSelect',
            data:function(){
                return {
                    formInline:{
                        desc:[]
                    },
                    options : jsonData
                };
            },
            methods: {
                handlechange:function(value){
                    $("#shopid").val(value);
                    tbjson(true);
                }
            }
        });
  }, 'json');

  //筛选后图表的数据
  function tbjson(a){
    var url ="",channel="";
        if(a){
            url = sxchange(false,true,true);
            p = JSON.stringify({
                  "info_owner_id":$("#shopid").val(),
                  "month":url[0]
                });
        }

    $.post("/glsb/customer-analysis/input-type",{r:r,p:p},function(response){
      var option = pieoption('option','渠道来源分布-线索',response.clue.chart);
          myChart.setOption(option);
      var table="";
          for(var i in response.clue.list){
              var proportion = deal(response.clue.list[i].proportion,"%");
                  table +="<tr><td>"+response.clue.list[i].input_type_name+"</td><td>"+response.clue.list[i].sum_num+"</td><td>"+proportion+"</td></tr>";
          }
          $("#channel-clew-table tbody").html(table);

      var option1 = pieoption('option1','渠道来源分布-意向',response.intention.chart);
          myChart1.setOption(option1);
      var table1="";
          for(var i in response.intention.list){
              var proportion = deal(response.intention.list[i].proportion,"%");
                  table1 +="<tr><td>"+response.intention.list[i].input_type_name+"</td><td>"+response.intention.list[i].sum_num+"</td><td>"+proportion+"</td></tr>";
          }
          $("#channel-intention-table tbody").html(table1);
    },'json');
  }

  $("body").delegate(".cascader-menu li","click",function(){
     if(!$(this).hasClass("submenu")){
        setTimeout(function() {tbjson(true);},300);
     }
  });

  $("body").delegate(".date-list .swiper-slide a","click",function(){
     setTimeout(function() {tbjson(true);},300);
  });
$("body").delegate(".el-cascader","click",function(){
    if($(".el-cascader").hasClass("is-opened"))
    {
      $(".el-cascader").parent().siblings().find("ul").addClass("none");
      $(".el-cascader").parent().siblings().find(".timelist").addClass("none");
      $(".el-cascader").siblings().removeClass("none");
    }
});

  $(window).resize(function(){
    myChart.resize();
    myChart1.resize();
  });

});
</script>
</body>
</html>